name: Crates building pipeline

on:
  workflow_dispatch:
    inputs:
      distro:
        description: 'ROS2 Distribution (leave empty for all)'
        required: false
        type: choice
        options:
          - rolling
          - jazzy
          - humble
          - iron
  push:
    branches:
      - main

jobs:
  pipeline:
    name: Build ${{ matrix.distro }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        distro: ${{ github.event_name == 'push' && fromJSON('["rolling"]') || (github.event.inputs.distro && fromJSON(format('["{0}"]', github.event.inputs.distro)) || fromJSON('["rolling", "jazzy", "humble", "iron"]')) }}
    env:
     TMP_DIR: /tmp/ros2-interfaces
     DISTRO: ${{ matrix.distro }}
     VERSION: ${{ github.run_number }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install

      - name: Install the project
        run: uv sync --locked --all-extras --dev

      - name: Create required folders
        run: mkdir -p ${{ env.TMP_DIR }}

      - name: Get ${{ env.DISTRO }} repos
        run: uv run scripts/query_repos.py --distro ${{ env.DISTRO }} --output ${{ env.TMP_DIR }}/list

      - name: Clone ${{ env.DISTRO }} repos
        run: uv run scripts/clone_repos.py --json-file ${{ env.TMP_DIR }}/list --output-dir ${{ env.TMP_DIR }}/cloned

      - name: Extract interfaces
        run: uv run scripts/extract_interfaces.py --distro ${{ env.DISTRO }} --json-file ${{ env.TMP_DIR }}/list --cloned-dir ${{ env.TMP_DIR }}/cloned --output-dir ${{ env.TMP_DIR }}/extracted

      - name: Convert to rust structs
        run: uv run scripts/convert_to_structs.py ${{ env.TMP_DIR }}/extracted/${{ env.DISTRO }} ${{ env.TMP_DIR }} ${{ env.DISTRO }} ${{ env.VERSION }}

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.82.0
          override: true

      - name: Check compilation
        working-directory: ${{ env.TMP_DIR }}
        run: cargo check --all-features

      - name: Test std_msgs publisher
        working-directory: ${{ env.TMP_DIR }}
        run: cargo test --test test_publisher --features std_msgs -- --nocapture

      - name: Update distro folder
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          cp -rf ${{ env.TMP_DIR }}/src ros2-interfaces-${{ env.DISTRO }}/
          git add ros2-interfaces-${{ env.DISTRO }}
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update ros2-interfaces-${{ env.DISTRO }} package: v0.0.${{ env.VERSION }}"
            git push origin main
          fi

      - name: Publish to crates.io
        if: github.event_name == 'workflow_dispatch'
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          dry-run: false
          path: ros2-interfaces-${{ env.DISTRO }}
          args: '--allow-dirty'

      - name: Clean the temp directory
        run: rm -rf ${{ env.TMP_DIR }}
